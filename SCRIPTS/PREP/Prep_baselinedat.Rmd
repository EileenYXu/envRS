---
title: "Baseline ABCD v5.1 prep"
author: "Eileen Xu"
date: "2024-09-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, results = "asis", warning = F)
library(tidyverse)
library(kableExtra)
options(knitr.kable.NA = '')
```

```{r}
dat = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/predictors_unrelatedIDs.rds")
baseline = dat %>% filter(eventname=="baseline_year_1_arm_1") %>% select_if(~ !all(is.na(.))) |> droplevels()
```

Total N = 9802 \
10% missing would be N = 980 missing \
20% = 1960 \
30% = 2940 \
40% = 3920 \
50% = 4901 \

```{r}
baseline |> select_if(~ is.numeric(.)) |> summary(.) |> kbl() |> kable_styling()
```

Due to TLFB screening out those who haven't heard of or tried the drug (more than a sip or a puff), NAs most likely to be 0. With how rare these events are at this age though `r round(min(baseline$interview_age, na.rm=T)/12, 2)` - `r round(max(baseline$interview_age, na.rm=T)/12, 2)` years, it may be worth removing this variable and examining it at year 2 instead of baseline.

```{r}
baseline |> select_if(~ is.factor(.)) |> summary() |> kbl() |> kable_styling()
```

Similar to above, may be better to remove illicit drugs from baseline analyses. Note on the "gender" variable: this is coded based on child's reported gender identity. M includes cis and trans males, F includes cis and trans females, GNC = gender non-conforming, combines "GNC" and "Different" from ABCD. 

```{r}
## remove any variables with >20% missing data?
baseline = baseline |> select_if(~ sum(is.na(.))<0.2*nrow(baseline))

baseline = baseline %>% select(-c(eventname, illicit, site_id_l, rel_family_id, rel_birth_id, interview_date, visit_type, birthsex))

names(baseline) = c("src_subject_id", "tobacco_puff", "weightcontrol_ksads", "witness_comm_violence", "death_loved_one", "witness_dv", "s_abuse", "p_abuse", "emot_abuse", "serious_accident", "sleep_hrs", "bmi", "needed_food", "income", "parent_ed", "gender_id", "gender", "race_ethnicity",
"area_depriv", "comm_safety", "days_active", "agemths", "cbcl_internalising", "cbcl_dsm5_depress")

# remove empty levels
baseline = droplevels(baseline)

# remove cbcl missing data
baseline = baseline %>% filter(!is.na(cbcl_internalising))
sapply(baseline, function(x) sum(is.na(x))) |> kbl(col.names = c("", "N missing")) |> kable_styling()
```

Little's MCAR test for continuous variables:

```{r}
baseline |> select_if(~ is.numeric(.)) |> naniar::mcar_test() |> kbl() |> kable_styling()
```

I plan on keeping the ethnicity variable in for missing data imputation

```{r}
mice::md.pattern(baseline, plot = F, rotate.names=T) |> kbl(col.names = c("N with pattern", names(baseline), "N missing in pattern")) |> kable_styling()
```

```{r}
## split into train and test samples ##
index = caret::createDataPartition(baseline$cbcl_internalising[which(is.na(baseline$cbcl_internalising)==F)], 
                            p = 0.2, list = F, times = 1)
traindat = baseline[-index,]
testdat = baseline[index,]
```

Training data:

```{r}
traindat[,-1] |> summarytools::dfSummary(plain.ascii = F, style = "grid", valid.col = F, graph.col = F, varnumbers = F)
```

Test data:

```{r}
testdat[,-1] |> summarytools::dfSummary(plain.ascii = F, style = "grid", valid.col = F, graph.col = F, varnumbers = F)
```


```{r eval=FALSE}
saveRDS(traindat, "G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/baseline_traindat.rds")
saveRDS(testdat, "G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/baseline_testdat.rds")
```

