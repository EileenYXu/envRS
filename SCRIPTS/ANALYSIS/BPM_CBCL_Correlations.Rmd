---
title: "envRS and BPM/CBCL/reporter discrepancies"
output:
  html_notebook:
    toc: true
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = "asis")
library(tidyverse)
library(lme4)
library(kableExtra)
```

```{r}
bpm = read.csv("G://users/eileen/ABCD/PRS_ABCD_Eileen/abcd_dep_long_gen_only.csv")
mddPRS = read.table("G://users/eileen/ABCD/PRS_ABCD_Eileen/abcd_mddipsych_prs_0831.t2.5.best", header = T)
cfPRS = read.table("G://users/eileen/ABCD/PRS_ABCD_Eileen/bpm_cf_prs_0817.t3.best", header = T)
hfPRS = read.table("G://users/eileen/ABCD/PRS_ABCD_Eileen/bpm_high_prs_0817.t2.best", header = T)
```

```{r}
envRS_b = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/envRS_baseline.rds")
names(envRS_b) = c("src_subject_id", "cbcl_dep", "depRS_min", "depRS_1se", "data", "cbcl_int", "intRS_min", "intRS_1se", "data.y")
envRS_b = envRS_b |> select(src_subject_id, cbcl_dep, cbcl_int, depRS_min, intRS_min)

envRS_y2 = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/envRS_y2.rds")
names(envRS_y2) = c("src_subject_id", "cbcl_dep", "depRS_min", "depRS_1se", "data", "cbcl_int", "intRS_min", "intRS_1se", "data.y")
envRS_y2 = envRS_y2 |> select(src_subject_id, cbcl_dep, cbcl_int, depRS_min, intRS_min)

bpm_wide = pivot_wider(bpm, names_from = "eventname", values_from = c("bpm_sum", "interview_age"))

dat_wide = bpm_wide |> mutate(
  cbcl_dep_b = envRS_b$cbcl_dep[match(bpm_wide$src_subject_id, envRS_b$src_subject_id)],
  cbcl_int_b = envRS_b$cbcl_int[match(bpm_wide$src_subject_id, envRS_b$src_subject_id)],
  depRS_b = envRS_b$depRS_min[match(bpm_wide$src_subject_id, envRS_b$src_subject_id)],
  intRS_b = envRS_b$intRS_min[match(bpm_wide$src_subject_id, envRS_b$src_subject_id)],
  cbcl_dep_y2 = envRS_y2$cbcl_dep[match(bpm_wide$src_subject_id, envRS_y2$src_subject_id)],
  cbcl_int_y2 = envRS_y2$cbcl_int[match(bpm_wide$src_subject_id, envRS_y2$src_subject_id)],
  depRS_y2 = envRS_y2$depRS_min[match(bpm_wide$src_subject_id, envRS_y2$src_subject_id)],
  intRS_y2 = envRS_y2$intRS_min[match(bpm_wide$src_subject_id, envRS_y2$src_subject_id)]
)
```

Correlation between envRS and BPM scores by timepoint - very very little correlation, even with CBCL. Perhaps due to scaling of CBCL?

```{r}
dat_wide[,grep("bpm_|RS_|cbcl", names(dat_wide))] |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed(upper = "color", lower = "number", order = "alphabet", tl.pos = "lt", tl.srt = 45, tl.cex=0.7, lower.col = "black", number.cex = 0.5, diag = "u") +
  theme(panel.grid = element_blank(), panel.background = element_blank())
```

Try with non-scaled CBCL. Correlations between BPM and CBCL scales still low??? \n
[Paper of BPM vs full CBCL](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4182328/) reported high correlations between internalising scales, I think maybe Poppy used sum of all BPM scales?

```{r fig.width=10, fig.height=10}
cbcldat = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/predictors_unrelatedIDs.rds") |> 
  select(src_subject_id, eventname, cbcl_scr_dsm5_depress_r, cbcl_scr_syn_internal_r)
names(cbcldat) = c("src_subject_id", "eventname", "cbcl_dep", "cbcl_int")
# make pivoted eventnames shorter
levels(cbcldat$eventname) = c("y1", "y2", "y3", "y4", "b")

cbcl_wide = pivot_wider(cbcldat, names_from = "eventname", values_from = c("cbcl_dep", "cbcl_int"))

merge(bpm_wide[,grep("src_|bpm", names(bpm_wide))], cbcl_wide) |> 
  select(-src_subject_id) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed(upper = "color", lower = "number", order = "alphabet", tl.pos = "lt", tl.srt = 45, tl.cex=0.7, lower.col = "black", number.cex = 0.5, diag = "u") +
  theme(panel.grid = element_blank(), panel.background = element_blank())  
```
Maybe something went wrong in data cleaning - what about raw BPM and CBCL directly from ABCD? OK nope it seems like potentially a bigger problem as raw scores from the same timepoints are not highly correlated. This doesn't change when using t scores either.

```{r}
cbcl = read.csv("G://data/abcd/release5.1/core/mental-health/mh_p_cbcl.csv")
bpm = read.csv("G://data/abcd/release5.1/core/mental-health/mh_y_bpm.csv")

abcd_bpm = bpm |> select(src_subject_id, eventname, bpm_y_scr_internal_r, bpm_y_scr_internal_t) |>
  filter(!grepl("_month_", eventname))
abcd_cbcl = cbcl |> 
  select(src_subject_id, eventname, cbcl_scr_syn_internal_r,
                           cbcl_scr_dsm5_depress_r, cbcl_scr_syn_internal_t, cbcl_scr_dsm5_depress_t)

abcd_dat = merge(abcd_bpm, abcd_cbcl)
abcd_dat |> group_by(eventname) |> 
  summarise(meanBPM = mean(bpm_y_scr_internal_r, na.rm=T),
            meanCBCLint = mean(cbcl_scr_syn_internal_r, na.rm=T),
            meanCBCLdep = mean(cbcl_scr_dsm5_depress_r, na.rm=T),
            corBPMint = cor(bpm_y_scr_internal_r, cbcl_scr_syn_internal_r, use = "pairwise.complete.obs", method="pearson"),
            corBPMdep = cor(bpm_y_scr_internal_r, cbcl_scr_dsm5_depress_r, use = "pairwise.complete.obs", method="pearson"),
            corCBCL = cor(cbcl_scr_syn_internal_r, cbcl_scr_dsm5_depress_r, use = "pairwise.complete.obs", method="pearson"),
            meanBPM_t = mean(bpm_y_scr_internal_t, na.rm=T),
            meanCBCLint_t = mean(cbcl_scr_syn_internal_t, na.rm=T),
            meanCBCLdep_t = mean(cbcl_scr_dsm5_depress_t, na.rm=T),
            corBPMint_t = cor(bpm_y_scr_internal_t, cbcl_scr_syn_internal_t, use = "pairwise.complete.obs", method="pearson"),
            corBPMdep_t = cor(bpm_y_scr_internal_t, cbcl_scr_dsm5_depress_t, use = "pairwise.complete.obs", method="pearson"),
            corCBCL_t = cor(cbcl_scr_syn_internal_t, cbcl_scr_dsm5_depress_t, use = "pairwise.complete.obs", method="pearson")) |> t() |> 
  kbl(digits = 3) |> kable_styling() |> scroll_box(height = 5)
```


```{r fig.height=10, fig.width=10}
abcd_dat = abcd_dat |> mutate(
  eventname = factor(eventname, labels = c("y1", "y2", "y3", "y4"))
)

names(abcd_dat) = c("src_subject_id", "eventname", "bpm_raw", "bpm_t", "cbcl_int_raw",
                    "cbcl_dep_raw", "cbcl_int_t", "cbcl_dep_t")

abcd_wide = pivot_wider(abcd_dat, names_from = "eventname", values_from = c("bpm_raw", "bpm_t", "cbcl_int_raw", "cbcl_dep_raw", "cbcl_int_t", "cbcl_dep_t"))

corplot = abcd_wide |> select(-src_subject_id) |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed(upper = "color", lower = "number", order = "alphabet", tl.pos = "lt", tl.srt = 45, tl.cex=0.7, lower.col = "black", number.cex = 0.5, diag = "u") +
  theme(panel.grid = element_blank(), panel.background = element_blank())


```

```{r}
ggplot(abcd_dat, aes(x=bpm_raw, y=cbcl_int_raw)) +
  geom_point(alpha=0.2) +
  geom_smooth(method = "lm", se = T) +
  facet_wrap(~eventname)
```

```{r}
corplot = abcd_wide[,grep("bpm_raw|cbcl_int_raw", names(abcd_wide))] |> 
  cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed(upper = "color", lower = "number", order = "alphabet", tl.pos = "lt", tl.srt = 45, tl.cex=0.7, lower.col = "black", number.cex = 0.5, diag = "u") +
  theme(panel.grid = element_blank(), panel.background = element_blank())
```

It could be difference in informants, ABCD did a teacher-report BPM so worth comparing with that data

```{r}
bpm_t = read.csv("G://data/abcd/release5.1/core/mental-health/mh_t_bpm.csv")

bpm_t = bpm_t |> select(src_subject_id, eventname, bpm_t_scr_internal_r, bpm_t_scr_internal_t)
bpm_all = merge(abcd_bpm, bpm_t) |> mutate(
  eventname = factor(eventname, labels = c("y1", "y2", "y3", "y4")))

names(bpm_all) = c("src_subject_id", "eventname", "youth_raw", "youth_t", "teach_raw", "teach_t")

bpm_all = pivot_wider(bpm_all, names_from = "eventname", values_from = c("youth_raw", "youth_t", "teach_raw", "teach_t"))

bpm_all[,-1] |> cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed(upper = "color", lower = "number", order = "alphabet", tl.pos = "lt", tl.srt = 45, tl.cex=0.7, lower.col = "black", number.cex = 0.5, diag = "u") +
  theme(panel.grid = element_blank(), panel.background = element_blank())
```

```{r}
merge(cbcl_wide, bpm_all) |> select(teach_raw_y1:teach_raw_y4, cbcl_int_y1:cbcl_int_y4) |> cor(use = "pairwise.complete.obs") |> 
  corrplot::corrplot.mixed(upper = "color", lower = "number", order = "alphabet", tl.pos = "lt", tl.srt = 45, tl.cex=0.7, lower.col = "black", number.cex = 0.5, diag = "u") +
  theme(panel.grid = element_blank(), panel.background = element_blank())
```

