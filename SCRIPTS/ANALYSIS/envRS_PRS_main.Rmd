---
title: "Combining depRS and PRS for longitudinal depression"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
editor_options:
  chunk_output_type: console
---

This script contains the longitudinal envRS analyses that will be included in the main manuscript. Cross-sectional depRS for baseline and year 2 data were trained on (standardised) CBCL DSM5-oriented depression subscale scores, PRS were based on the MDD3 GWAS. All continuous variables have been mean centred and standardised for comparison of effect sizes. Longitudinal outcomes examined here are **CBCL DSM-5 oriented depression subscale** at  (a) Year 4 and **Lifetime MDD status** at Year 2 which was either (b) Self-reported or (c) Parent-reported. Longitudinal analyses of depRS at year 2 looked at (d) Year 4 CBCL.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results = "asis")
library(tidyverse)
library(lme4)
library(kableExtra)
library(lmerTest)
library(emmeans)
library(performance)
library(pROC)
library(summarytools)
define_keywords(title.dfSummary = "NA")
pal = paletteer::paletteer_d("colorblindr::OkabeIto")

emm_options(lmerTest.limit = 30000, pbkrtest.limit = 30000)
```

```{r}
ids = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/unrelatedIDs.rds")

cbcl = read.csv("G://data/abcd/release5.1/core/mental-health/mh_p_cbcl.csv") |> filter(src_subject_id %in% ids) |> select(src_subject_id, eventname, cbcl_scr_syn_internal_r, cbcl_scr_dsm5_depress_r)
names(cbcl) = c("src_subject_id", "eventname", "int", "dep")

lt = read.csv("G://data/abcd/release5.1/core/abcd-general/abcd_y_lt.csv") |> filter(src_subject_id %in% ids) |> 
  select(src_subject_id, eventname, interview_age) |> 
  mutate(age_yrs = interview_age/12)

cbcl = merge(lt, cbcl, by = c("src_subject_id", "eventname"))

cbcl_y4 = cbcl |> filter(eventname=="4_year_follow_up_y_arm_1") |> 
  mutate(across("int":"dep", scale))
```

```{r scores}
PRS = read.table("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/poppy_PRS/abcd_mdd3_prs_1024.t3.5.best", header = T) |> select(IID, PRS) |> mutate(across(where(is.numeric), scale))

depRS_b = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/depRS_baseline.rds") |> select(src_subject_id, lambda.min)
names(depRS_b) = c("src_subject_id", "depRS_b")
intRS_b = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/intRS_baseline.rds") |> select(src_subject_id, lambda.min)
names(intRS_b) = c("src_subject_id", "intRS_b")

envRS = merge(depRS_b, intRS_b, by = "src_subject_id") |> mutate(across(where(is.numeric), scale))

scores = merge(envRS, PRS, by.x = "src_subject_id", by.y = "IID")
```

# Baseline depRS

PRS data based on MDD3 GWAS (from Poppy) were available for `r nrow(PRS)` participants. 


## (a) Y4 CBCL Depression {.tabset}

```{r}
y4_dat = merge(cbcl_y4, scores, by="src_subject_id")
```

At year 4, CBCL data were available for `r nrow(cbcl_y4)` participants. A total `r nrow(y4_dat)` participants have year 4 CBCL data, PRS and baseline envRS. \
\
Model comparisons are run for: \
\
m1 = cbcl ~ envRS \
m2 = cbcl ~ envRS + PRS \
m3 = cbcl ~ envRS*PRS 

### Performance metrics

```{r}
mPRS = lm(dep ~ PRS, data = y4_dat)
m1 = lm(dep ~ depRS_b, data = y4_dat)
m2 = lm(dep ~ depRS_b + PRS, data = y4_dat)
m3 = lm(dep ~ depRS_b*PRS, data = y4_dat)

mods = list("m1" = m1, "PRS"=mPRS, "m2" = m2, "m3" = m3)

compare_performance(m1, mPRS, m2, m3, verbose = F) |> display(digits=3)

accs = lapply(mods, performance_accuracy) 
accs = lapply(accs, as.data.frame) |> bind_rows(.id = "model")
kable(accs, digits = 3) |> kable_styling()
```


### Model comparisons

Adding PRS to depRS:

```{r}
test_performance(m1, m2, m3) |> display(digits=3)
```

Adding depRS to PRS:

```{r}
test_performance(mPRS, m2, m3) |> display(digits=3)
```


### Estimates

```{r}
sjPlot::tab_model(mods, dv.labels = c("m1", "PRS", "m2", "m3"), collapse.ci = T, show.se = T, show.stat = T)
```

### Data description

```{r}
y4_dat |> select(age_yrs, dep, depRS_b) |> dfSummary(plain.ascii = F, style = "grid", valid.col = F, graph.col = T, varnumbers = F, tmp.img.dir = "/tmp", max.tbl.height = 300) |> print(method = "render")
```


## (c) 2-year lifetime MDD diagnosis (youth) {.tabset}

```{r}
mddy = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/ksads_y.rds")

mddy = lapply(mddy, function(x) {
  y = merge(x, lt, by = c("src_subject_id", "eventname"))
  mutate(y, age_yrs = interview_age/12)
  return(y)
})

y2dat_y = merge(envRS, mddy$y2, by = "src_subject_id")
y2prs_y = merge(scores, mddy$y2, by = "src_subject_id")
```


Of those with both envRS and PRS at Y2 (N = `r nrow(y2prs_y)`), there are `r nrow(filter(y2prs_y, mdd_lifetime==1))` lifetime MDD cases. \
\
`r nrow(filter(y2prs_y, mdd_present==1))` current MDD cases and `r nrow(filter(y2prs_y, any_lifetime==1))` cases with lifetime diagnoses of a depressive disorder (Major Depressive Disorder, Persistent Depressive Disorder (dysthymia), Depressive Disorder Unspecified). 


### Performance metrics

```{r}
mPRS = glm(mdd_lifetime ~ PRS, y2prs_y, family = binomial(link="logit"))
m1 = glm(mdd_lifetime ~ depRS_b, y2prs_y, family = binomial(link = "logit"))
m2 = glm(mdd_lifetime ~ depRS_b + PRS, y2prs_y, family = binomial(link = "logit"))
m3 = glm(mdd_lifetime ~ depRS_b*PRS, y2prs_y, family = binomial(link = "logit"))

mods = list(m1, mPRS, m2, m3)

compare_performance(mods, verbose = F) |> display(digits=3)

accs = lapply(mods, performance_accuracy) 

accs = lapply(accs, as.data.frame) |> bind_rows(.id = "model")
kable(accs, digits = 3) |> kable_styling()
```

### Model comparisons

Adding PRS to depRS:

```{r}
test_performance(m1, m2, m3) |> display(digits=3)
```

Adding depRS to PRS:

```{r}
test_performance(mPRS, m2, m3) |> display(digits=3)
```

### Estimates

```{r}
sjPlot::tab_model(mods, dv.labels = c("m1", "mPRS", "m2", "m3"), collapse.ci = T, show.se = T, show.stat = T)
```

### ROC curves

```{r}
#ROC curves for each model
roc_m1 = roc(y2prs_y$mdd_lifetime, m1$fitted.values) 
roc_m2 = roc(y2prs_y$mdd_lifetime, m2$fitted.values)
roc_m3 = roc(y2prs_y$mdd_lifetime, m3$fitted.values)

ggroc(list("depRS" = roc_m1, "depRS + PRS" = roc_m2, "depRS*PRS" = roc_m3)) +
  scale_color_manual(values = pal) +
  geom_segment(aes(x=1, y=0, xend=0, yend=1), colour = "black", alpha = 0.7, linetype = "dotted") +
  theme_bw() + 
  labs(x = "Specificity", y = "Sensitivity", color = "Model")
```

### Data description

```{r}
y2prs_y |> select(age_yrs, mdd_lifetime, depRS_b) |> dfSummary(plain.ascii = F, style = "grid", valid.col = F, graph.col = T, varnumbers = F, tmp.img.dir = "/tmp", max.tbl.height = 300) |> print(method = "render")
```

## (c) 2-year lifetime MDD diagnosis (parent) {.tabset}

```{r}
mddp = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/ksads_p.rds")

mddp = lapply(mddp, function(x) {
  y = merge(x, lt, by = c("src_subject_id", "eventname"))
  mutate(y, age_yrs = interview_age/12)
  return(y)
})

y2dat_p = merge(envRS, mddp$y2, by = "src_subject_id")
y2prs_p = merge(scores, mddp$y2, by = "src_subject_id")
```

Of those with both envRS and PRS at Y2 (N = `r nrow(y2prs_p)`), there are `r nrow(filter(y2prs_p, mdd_lifetime==1))` lifetime MDD cases. \
\
`r nrow(filter(y2prs_p, mdd_present==1))` current MDD cases and `r nrow(filter(y2prs_p, any_lifetime==1))` cases with lifetime diagnoses of a depressive disorder (Major Depressive Disorder, Persistent Depressive Disorder (dysthymia), Depressive Disorder Unspecified).

### Performance metrics

```{r}
m1 = glm(mdd_lifetime ~ depRS_b, y2prs_p, family = binomial(link = "logit"))
mPRS = glm(mdd_lifetime ~ PRS, y2prs_p, family = binomial(link = "logit"))
m2 = glm(mdd_lifetime ~ depRS_b + PRS, y2prs_p, family = binomial(link = "logit"))
m3 = glm(mdd_lifetime ~ depRS_b*PRS, y2prs_p, family = binomial(link = "logit"))

mods = list(m1, mPRS, m2, m3)

compare_performance(mods, verbose = F) |> display(digits=3)

accs = lapply(mods, performance_accuracy) 

accs = lapply(accs, as.data.frame) |> bind_rows(.id = "model")
kable(accs, digits = 3) |> kable_styling()
```

### Model comparisons

Adding PRS to depRS:

```{r}
test_performance(m1, m2, m3) |> display(digits=3)
```

Adding depRS to PRS:

```{r}
test_performance(mPRS, m2, m3) |> display(digits=3)
```

### Estimates

```{r}
sjPlot::tab_model(mods, dv.labels = c("m1", "PRS","m2", "m3"), collapse.ci = T, show.se = T, show.stat = T)
```

### ROC curves

```{r}
#ROC curves for each model
roc_m1 = roc(y2prs_p$mdd_lifetime, m1$fitted.values)
roc_m2 = roc(y2prs_p$mdd_lifetime, m2$fitted.values)
roc_m3 = roc(y2prs_p$mdd_lifetime, m3$fitted.values)

ggroc(list("depRS" = roc_m1, "depRS + PRS" = roc_m2, "depRS*PRS" = roc_m3)) +
  scale_color_manual(values = pal) +
  geom_segment(aes(x=1, y=0, xend=0, yend=1), colour = "black", alpha = 0.7, linetype = "dotted") +
  theme_bw() + 
  labs(x = "Specificity", y = "Sensitivity", color = "Model")
```

### Data description

```{r}
y2prs_p |> select(age_yrs, mdd_lifetime, depRS_b) |> dfSummary(plain.ascii = F, style = "grid", valid.col = F, graph.col = T, varnumbers = F, tmp.img.dir = "/tmp", max.tbl.height = 300) |> print(method = "render")
```



## (d) depRS at Y2 predicting Y4 CBCL Depression {.tabset}

```{r}
depRS_y2 = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/depRS_y2.rds") |> select(src_subject_id, lambda.min)

names(depRS_y2) = c("src_subject_id", "depRS_y2")

intRS_y2 = readRDS("G://users/eileen/ABCD/ABCD_Environmental_Risk/ABCDv5.1/DATA/intRS_y2.rds") |> select(src_subject_id, lambda.min)
 
names(intRS_y2) = c("src_subject_id", "intRS_y2")
 
envRS = merge(depRS_y2, intRS_y2, by = "src_subject_id") |> mutate(across(where(is.numeric), scale))

y2scores = merge(envRS, PRS, by.x = "src_subject_id", by.y = "IID")
```


```{r}
y4_dat = merge(cbcl_y4, y2scores, by="src_subject_id")
```

At year 4, CBCL data were available for `r nrow(cbcl_y4)` participants. A total `r nrow(y4_dat)` participants have year 4 CBCL data, PRS and Y2 envRS. \
\
Model comparisons are run for: \
\
m1 = cbcl ~ envRS \
m2 = cbcl ~ envRS + PRS \
m3 = cbcl ~ envRS*PRS

### Performance metrics

```{r}
m1 = lm(dep ~ depRS_y2, data = y4_dat)
mPRS = lm(dep ~ PRS, data = y4_dat)
m2 = lm(dep ~ depRS_y2 + PRS, data = y4_dat)
m3 = lm(dep ~ depRS_y2*PRS, data = y4_dat)

mods = list("m1" = m1, "PRS" = mPRS, "m2" = m2, "m3" = m3)

compare_performance(mods, verbose = F) |> display(digits=3)

accs = lapply(mods, performance_accuracy) 
accs = lapply(accs, as.data.frame) |> bind_rows(.id = "model")
kable(accs, digits = 3) |> kable_styling()
```

### Model comparisons

Adding PRS to depRS:

```{r}
test_performance(m1, m2, m3) |> display(digits=3)
```

Adding depRS to PRS:

```{r}
test_performance(mPRS, m2, m3) |> display(digits=3)
```

### Estimates

```{r}
sjPlot::tab_model(mods, dv.labels = c("m1", "PRS", "m2", "m3"), collapse.ci = T, show.se = T, show.stat = T)
```

### Data description

```{r}
y4_dat |> select(age_yrs, dep, depRS_y2) |> dfSummary(plain.ascii = F, style = "grid", valid.col = F, graph.col = T, varnumbers = F, tmp.img.dir = "/tmp", max.tbl.height = 300) |> print(method = "render")
```
